<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="/static/img/favicon.ico" />
    <title>Streaming Server Using Kqueue - Problems and Algorithms</title>
    <meta name="author" content="Nima Aghdaii" />
    <meta name="description" content="Streaming Server Using Kqueue" />
    <meta name="keywords" content="Streaming Server Using Kqueue, Problems and Algorithms, C, kqueue, streaming, server, network, learning, linux, kernel" />
    <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml">
    <meta content="" property="fb:app_id">
    <meta content="Problems and Algorithms" property="og:site_name">

    

    
      <meta content="Streaming Server Using Kqueue" property="og:title">
      <meta content="article" property="og:type">
    

    
      <meta content="Problems and Algorithms" property="og:description">
    

    
      <meta content="http://localhost:4000/kqueue_server" property="og:url">
    

    
      <meta content="2020-03-10T08:09:33-07:00" property="article:published_time">
      <meta content="http://localhost:4000/about/" property="article:author">
    

    
      <meta content="http://localhost:4000/static/img/avatar.jpg" property="og:image">
    

    
      
        <meta content="C" property="article:section">
      
    

    
      
    

    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@">
    <meta name="twitter:creator" content="@">

    
      <meta name="twitter:title" content="Streaming Server Using Kqueue">
    

    
      <meta name="twitter:url" content="http://localhost:4000/kqueue_server">
    

    
      <meta name="twitter:description" content="Problems and Algorithms">
    

    

    <!-- Font awesome icons -->
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
    <!-- syntax highlighting CSS -->
    <link rel="stylesheet" href="/static/css/syntax.css">
    <!-- Bootstrap core CSS -->
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Roboto+Condensed:400,300italic,300,400italic,700&amp;subset=latin,latin-ext" rel="stylesheet" type="text/css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/css/super-search.css">
    <link rel="stylesheet" href="/static/css/thickbox.css">
    <link rel="stylesheet" href="/static/css/projects.css">
    <link rel="stylesheet" href="/static/css/main.css">

    
  </head>
  <body>
    <div class="container">
      <div class="col-sm-3">
        <div class="fixed-condition">
          <a href="/"><img class="profile-avatar" src="/static/img/avatar.jpg" height="75px" width="75px" /></a>
          <h1 class="author-name">Nima Aghdaii</h1>
          
            <div class="profile-about">
              I like algorithms and problem solving.
            </div>
          
          <div class="social">
            <ul>
              
                <li><a href="https://www.linkedin.com/in/nima-aghdaii-074b7536/" target="_blank"><i class="fa fa-linkedin"></i></a></li>
              
                <li><a href="https://github.com/nima101" target="_blank"><i class="fa fa-github"></i></a></li>
              
            </ul>
          </div>
          <div class="search" id="js-search">
            <input type="text" placeholder="(sitemap)~$ type to search" class="search__input form-control" id="js-search__input">
            <ul class="search__results" id="js-search__results"></ul>
          </div>
          <hr />
          <ul class="sidebar-nav">
            <strong>Navigation</strong>
            <li><a href="/">Home</a></li>
            
              <li><a class="about" href="/about/">About Me</a></li>
            
              <li><a class="about" href="/feed.xml">XML Feed</a></li>
            
          </ul>
        </div>
        <!-- end /.fixed-condition -->
      </div>
      <div class="col-sm-8 col-offset-1 main-layout">
        <header class="post-header">
  <h1 class="post-title">Streaming Server Using Kqueue</h1>
</header>

<span class="time">10 Mar 2020</span>

  <span class="categories">
    &raquo; <a href="/category/C">C</a>, <a href="/category/kqueue">kqueue</a>, <a href="/category/streaming">streaming</a>, <a href="/category/server">server</a>, <a href="/category/network">network</a>, <a href="/category/learning">learning</a>, <a href="/category/linux">linux</a>, <a href="/category/kernel">kernel</a>
  </span>


<div class="content">
  <div class="post"><p>I worked on this small project to better understand how <a href="https://man.openbsd.org/kqueue">kqueue</a> works. Let’s implement a bidirectional streaming server using kqueue only in 100 lines (in C)!</p>

<p>Note: If you want to learn more about kqueue fundamentals, read <a href="/io_multiplexing">this post</a> first.</p>

<p><br /></p>

<h3 id="design">Design</h3>

<ol>
  <li>The server starts up on port <code class="language-plaintext highlighter-rouge">8080</code></li>
  <li>Enters the event loop where we handle:
    <ul>
      <li>New connections</li>
      <li>Disconnections</li>
      <li>Sending/receiving messages</li>
    </ul>
  </li>
</ol>

<p><br /></p>

<h4 id="starting-the-server">Starting the server</h4>
<p>In order to start the server we need to:</p>
<ol>
  <li><strong>Create</strong> a socket</li>
  <li><strong>Bind</strong> it to an address (<code class="language-plaintext highlighter-rouge">&lt;localhost, port 8080&gt;</code>)</li>
  <li><strong>Listen</strong> on the socket for incoming connections</li>
</ol>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">create_socket_and_listen</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">addrinfo</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">addrinfo</span> <span class="n">hints</span><span class="p">;</span>
    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hints</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">hints</span><span class="p">);</span>
    <span class="n">hints</span><span class="p">.</span><span class="n">ai_flags</span> <span class="o">=</span> <span class="n">AI_PASSIVE</span><span class="p">;</span>
    <span class="n">hints</span><span class="p">.</span><span class="n">ai_family</span> <span class="o">=</span> <span class="n">PF_UNSPEC</span><span class="p">;</span>
    <span class="n">hints</span><span class="p">.</span><span class="n">ai_socktype</span> <span class="o">=</span> <span class="n">SOCK_STREAM</span><span class="p">;</span>
    <span class="n">getaddrinfo</span><span class="p">(</span><span class="s">"127.0.0.1"</span><span class="p">,</span> <span class="s">"8080"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hints</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">local_s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">ai_family</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">ai_socktype</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">ai_protocol</span><span class="p">);</span>
    <span class="n">bind</span><span class="p">(</span><span class="n">local_s</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">ai_addr</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">ai_addrlen</span><span class="p">);</span>
    <span class="n">listen</span><span class="p">(</span><span class="n">local_s</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">local_s</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>Next,</p>
<ol>
  <li>create an empty kqueue</li>
  <li>create an eventSet for READs on the socket</li>
  <li>add evSet to the kqueue</li>
</ol>

<p>Note: for (2), refer to the man page for <a href="https://man.openbsd.org/kqueue">kevent</a> (<code class="language-plaintext highlighter-rouge">EVFILT_READ</code> section):</p>
<blockquote>
  <p>Sockets which have previously been passed to listen() return when there is an incoming connection pending.</p>
</blockquote>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">local_s</span> <span class="o">=</span> <span class="n">create_socket_and_listen</span><span class="p">();</span>
    <span class="kt">int</span> <span class="n">kq</span> <span class="o">=</span> <span class="n">kqueue</span><span class="p">();</span>
    <span class="k">struct</span> <span class="n">kevent</span> <span class="n">evSet</span><span class="p">;</span>
    <span class="n">EV_SET</span><span class="p">(</span><span class="o">&amp;</span><span class="n">evSet</span><span class="p">,</span> <span class="n">local_s</span><span class="p">,</span> <span class="n">EVFILT_READ</span><span class="p">,</span> <span class="n">EV_ADD</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">kevent</span><span class="p">(</span><span class="n">kq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">evSet</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">run_event_loop</span><span class="p">(</span><span class="n">kq</span><span class="p">,</span> <span class="n">local_s</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"success</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>Then we enter the event loop where we handle incomming connections and send/receive messages.</p>

<p><br /></p>

<h4 id="accepting-connections">Accepting Connections</h4>

<p>Each time we receive a new connection from a client, we <a href="http://man7.org/linux/man-pages/man2/accept.2.html">accept</a> the connection. The <code class="language-plaintext highlighter-rouge">accept(..)</code> system call basically does the tcp 3-way handshake and creates a socket for further communication with that client and returns the file descriptor of that socket. We need to store these file descriptors for each client so we can communicate with them.</p>

<p><br /></p>

<h4 id="connection-pooling">Connection Pooling</h4>

<p>Let’s store an array of <code class="language-plaintext highlighter-rouge">client_data</code> (which contains the socket’s fd), and initially all of them have <code class="language-plaintext highlighter-rouge">fd = 0</code>, which means “unused”.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">struct</span> <span class="n">client_data</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
<span class="p">}</span> <span class="n">clients</span><span class="p">[</span><span class="n">NUM_CLIENTS</span><span class="p">];</span></code></pre></figure>

<p>Operations:</p>
<ol>
  <li><strong>Lookup:</strong> Given a fd, we can find the corresponding <code class="language-plaintext highlighter-rouge">client_data</code> by simply iterating over the array</li>
  <li><strong>Add:</strong> For new connections, we find the first free item (<code class="language-plaintext highlighter-rouge">fd = 0</code>) in the array to store the client’s fd</li>
  <li><strong>Delete:</strong> When the connection is lost, we free that item in the array by setting it’s fd to <code class="language-plaintext highlighter-rouge">0</code></li>
</ol>

<p>Below is the code for these three operations:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">get_conn</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_CLIENTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fd</span> <span class="o">==</span> <span class="n">fd</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">conn_add</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">get_conn</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fd</span> <span class="o">=</span> <span class="n">fd</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">conn_del</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">get_conn</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p><br /></p>

<h4 id="event-loop">Event Loop</h4>

<p>Now, we create an infinite loop where we call <code class="language-plaintext highlighter-rouge">kevent(..)</code> to receive incoming events and process them.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">num_events</span> <span class="o">=</span> <span class="n">kevent</span><span class="p">(</span><span class="n">kq</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">evList</span><span class="p">,</span> <span class="n">MAX_EVENTS</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_events</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* handle events */</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>So far, we have registered to receive incoming connections on the main socket. When we receive such event, we <a href="http://man7.org/linux/man-pages/man2/accept.2.html">accept()</a> the connection and store the new socket’s fd in our connection pool. We also register for the incoming messages from that client (on the same kqueue). We also send them a welcome message on this new socket!</p>

<p>When a client disconnects, we receive an event where the <code class="language-plaintext highlighter-rouge">EOF</code> flag is set on the socket. We simply free up that connection in the pool and remove the event from kqueue (via <code class="language-plaintext highlighter-rouge">EV_DELETE</code>).</p>

<p>Finally, we handle incoming data from clients and receive their message.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">num_events</span> <span class="o">=</span> <span class="n">kevent</span><span class="p">(</span><span class="n">kq</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">evList</span><span class="p">,</span> <span class="n">MAX_EVENTS</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_events</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// receive new connection</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">evList</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ident</span> <span class="o">==</span> <span class="n">local_s</span><span class="p">)</span> <span class="p">{</span>
            <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">evList</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ident</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">socklen</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">conn_add</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">EV_SET</span><span class="p">(</span><span class="o">&amp;</span><span class="n">evSet</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">EVFILT_READ</span><span class="p">,</span> <span class="n">EV_ADD</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
                <span class="n">kevent</span><span class="p">(</span><span class="n">kq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">evSet</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
                <span class="n">send_welcome_msg</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"connection refused.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="c1">// client disconnected</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">evList</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">EV_EOF</span><span class="p">)</span> <span class="p">{</span>
            <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">evList</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ident</span><span class="p">;</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"client #%d disconnected.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">get_conn</span><span class="p">(</span><span class="n">fd</span><span class="p">));</span>
            <span class="n">EV_SET</span><span class="p">(</span><span class="o">&amp;</span><span class="n">evSet</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">EVFILT_READ</span><span class="p">,</span> <span class="n">EV_DELETE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
            <span class="n">kevent</span><span class="p">(</span><span class="n">kq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">evSet</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
            <span class="n">conn_del</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
        <span class="p">}</span> <span class="c1">// read message from client</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">evList</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">filter</span> <span class="o">==</span> <span class="n">EVFILT_READ</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">recv_msg</span><span class="p">(</span><span class="n">evList</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ident</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p><br /></p>

<h3 id="complete-code">Complete Code</h3>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#include &lt;err.h&gt;
#include &lt;netdb.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;sys/event.h&gt;
#include &lt;sys/socket.h&gt;
#include &lt;unistd.h&gt;
</span>
<span class="cp">#define NUM_CLIENTS 10
#define MAX_EVENTS 32
#define MAX_MSG_SIZE 256
</span>
<span class="k">struct</span> <span class="n">client_data</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
<span class="p">}</span> <span class="n">clients</span><span class="p">[</span><span class="n">NUM_CLIENTS</span><span class="p">];</span>

<span class="kt">int</span> <span class="nf">get_conn</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_CLIENTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fd</span> <span class="o">==</span> <span class="n">fd</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">conn_add</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">get_conn</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fd</span> <span class="o">=</span> <span class="n">fd</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">conn_del</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">get_conn</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">recv_msg</span><span class="p">(</span><span class="kt">int</span> <span class="n">s</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">MAX_MSG_SIZE</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">bytes_read</span> <span class="o">=</span> <span class="n">recv</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">buf</span><span class="p">[</span><span class="n">bytes_read</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"client #%d: %s"</span><span class="p">,</span> <span class="n">get_conn</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">buf</span><span class="p">);</span>
    <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">send_welcome_msg</span><span class="p">(</span><span class="kt">int</span> <span class="n">s</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">msg</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>
    <span class="n">sprintf</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="s">"welcome! you are client #%d!</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">get_conn</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>
    <span class="n">send</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">run_event_loop</span><span class="p">(</span><span class="kt">int</span> <span class="n">kq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">local_s</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">kevent</span> <span class="n">evSet</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">kevent</span> <span class="n">evList</span><span class="p">[</span><span class="n">MAX_EVENTS</span><span class="p">];</span>
    <span class="k">struct</span> <span class="n">sockaddr_storage</span> <span class="n">addr</span><span class="p">;</span>
    <span class="n">socklen_t</span> <span class="n">socklen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>

    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">num_events</span> <span class="o">=</span> <span class="n">kevent</span><span class="p">(</span><span class="n">kq</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">evList</span><span class="p">,</span> <span class="n">MAX_EVENTS</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_events</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// receive new connection</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">evList</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ident</span> <span class="o">==</span> <span class="n">local_s</span><span class="p">)</span> <span class="p">{</span>
                <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">evList</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ident</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">socklen</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">conn_add</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">EV_SET</span><span class="p">(</span><span class="o">&amp;</span><span class="n">evSet</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">EVFILT_READ</span><span class="p">,</span> <span class="n">EV_ADD</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
                    <span class="n">kevent</span><span class="p">(</span><span class="n">kq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">evSet</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
                    <span class="n">send_welcome_msg</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">printf</span><span class="p">(</span><span class="s">"connection refused.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="c1">// client disconnected</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">evList</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">EV_EOF</span><span class="p">)</span> <span class="p">{</span>
                <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">evList</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ident</span><span class="p">;</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"client #%d disconnected.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">get_conn</span><span class="p">(</span><span class="n">fd</span><span class="p">));</span>
                <span class="n">EV_SET</span><span class="p">(</span><span class="o">&amp;</span><span class="n">evSet</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">EVFILT_READ</span><span class="p">,</span> <span class="n">EV_DELETE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
                <span class="n">kevent</span><span class="p">(</span><span class="n">kq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">evSet</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
                <span class="n">conn_del</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
            <span class="p">}</span> <span class="c1">// read message from client</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">evList</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">filter</span> <span class="o">==</span> <span class="n">EVFILT_READ</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">recv_msg</span><span class="p">(</span><span class="n">evList</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ident</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">create_socket_and_listen</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">addrinfo</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">addrinfo</span> <span class="n">hints</span><span class="p">;</span>
    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hints</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">hints</span><span class="p">);</span>
    <span class="n">hints</span><span class="p">.</span><span class="n">ai_flags</span> <span class="o">=</span> <span class="n">AI_PASSIVE</span><span class="p">;</span>
    <span class="n">hints</span><span class="p">.</span><span class="n">ai_family</span> <span class="o">=</span> <span class="n">PF_UNSPEC</span><span class="p">;</span>
    <span class="n">hints</span><span class="p">.</span><span class="n">ai_socktype</span> <span class="o">=</span> <span class="n">SOCK_STREAM</span><span class="p">;</span>
    <span class="n">getaddrinfo</span><span class="p">(</span><span class="s">"127.0.0.1"</span><span class="p">,</span> <span class="s">"8080"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hints</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">local_s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">ai_family</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">ai_socktype</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">ai_protocol</span><span class="p">);</span>
    <span class="n">bind</span><span class="p">(</span><span class="n">local_s</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">ai_addr</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">ai_addrlen</span><span class="p">);</span>
    <span class="n">listen</span><span class="p">(</span><span class="n">local_s</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">local_s</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">local_s</span> <span class="o">=</span> <span class="n">create_socket_and_listen</span><span class="p">();</span>
    <span class="kt">int</span> <span class="n">kq</span> <span class="o">=</span> <span class="n">kqueue</span><span class="p">();</span>
    <span class="k">struct</span> <span class="n">kevent</span> <span class="n">evSet</span><span class="p">;</span>
    <span class="n">EV_SET</span><span class="p">(</span><span class="o">&amp;</span><span class="n">evSet</span><span class="p">,</span> <span class="n">local_s</span><span class="p">,</span> <span class="n">EVFILT_READ</span><span class="p">,</span> <span class="n">EV_ADD</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">kevent</span><span class="p">(</span><span class="n">kq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">evSet</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">run_event_loop</span><span class="p">(</span><span class="n">kq</span><span class="p">,</span> <span class="n">local_s</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p><br /></p>

<h3 id="all-done">All Done!</h3>
<ol>
  <li>This is a simple implementation just to demonstrate how kqueue works. It lacks many things including handling sys call failures, handling large messages correctly, etc.</li>
  <li>As an exercise, add a feature where server can also read messages from <code class="language-plaintext highlighter-rouge">stdin</code> and broadcast them to all clients.</li>
  <li>Everything seems rather efficient except the fact that the call to <code class="language-plaintext highlighter-rouge">accept</code> does a tcp 3-way handshake, which incurs an extra roundtrip. You may wonder if that’s necessary and can we avoid that round trip fully or partially. While the 3-way handshake is necessary for tcp connections, <a href="https://pcarleton.com/2018/06/06/why-does-tcp-need-a-3-way-handshake-anyway/">this external post</a> explains some alternatives such as TCP Fast Open (TFO) or QUIC (TLS over UDP).</li>
</ol>

<p><br /></p>

<p>Below is a demo where I run the server on the lift and 4 clients on the right.</p>

<p><strong>Note:</strong> For the client side, I use the linux utility <a href="https://man.openbsd.org/nc.1">nc(netcat)</a>. You can run <code class="language-plaintext highlighter-rouge">nc -l PORT</code> to listen on a port or run <code class="language-plaintext highlighter-rouge">nc HOST PORT</code> to connect to a server and send data (once connected, type your msg and press enter to send).</p>

<p><img src="http://localhost:4000/static/img/tcp_server.gif" alt="gif" height="100%" width="100%" /></p>

<p><br /></p>

</div>
  <div class="share-page">
  <span style="float: left;">Share this on &rarr;&nbsp;&nbsp;</span>

  <!-- Twitter -->
  <a href="https://twitter.com/share" class="twitter-share-button" data-via="">Tweet</a>
  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  <!-- Facebook -->
  <div class="fb-share-button" data-href="http://localhost:4000/kqueue_server" data-layout="button_count" style="position: relative; top: -8px; left: 3px;"></div>
</div>

<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.6&appId=";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

</div>


  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
            
            <div class="panel-body">
              <h4>Related Posts</h4>
              <ul>
            
                <li class="relatedPost">
                  <a href="http://localhost:4000/io_multiplexing">I/O Multiplexing (select vs. poll vs. epoll/kqueue)</a>
                  
                    (Categories: <a href="/category/C">C</a>, <a href="/category/select">select</a>, <a href="/category/poll">poll</a>, <a href="/category/kqueue">kqueue</a>, <a href="/category/network">network</a>, <a href="/category/learning">learning</a>, <a href="/category/linux">linux</a>, <a href="/category/kernel">kernel</a>)
                  
                </li>
          
          
        
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
        
          
      
          
      
          
      
          
      
          
      
          
      
          
      
          
      
    
  
  
  </ul>
</div>


<div class="PageNavigation">
  
    <a class="prev" href="/io_multiplexing">&laquo; I/O Multiplexing (select vs. poll vs. epoll/kqueue)</a>
  
  
    <a class="next" href="/tetration_fractal">Tetration Fractal &raquo;</a>
  
</div>

<div class="disqus-comments">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    /* <![CDATA[ */
    var disqus_shortname = "nima101algoblog";
    var disqus_identifier = "http://localhost:4000_Streaming Server Using Kqueue";
    var disqus_title = "Streaming Server Using Kqueue";

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    /* ]]> */
  </script>
</div>

        <footer>
          &copy; Nima Aghdaii
          
            - <a href="https://github.com/nima101">https://github.com/nima101</a> - Powered by Jekyll.
          
          <div class="btn-github" style="float:right;">
            <iframe src="https://ghbtns.com/github-btn.html?user=nima101&repo=nima101.github.io&type=star&count=true" frameborder="0" scrolling="0" width="85" height="20px"></iframe>
            <iframe src="https://ghbtns.com/github-btn.html?user=nima101&repo=nima101.github.io&type=fork&count=true" frameborder="0" scrolling="0" width="85" height="20px"></iframe>
          </div>
        </footer>
      </div>
      <!-- end /.col-sm-8 -->
    </div>
    <!-- end /.container -->

    <!-- Bootstrap core JavaScript -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script src="//code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
    <script src="/static/js/bootstrap.min.js"></script>
    <script src="/static/js/super-search.js"></script>
    <script src="/static/js/thickbox-compressed.js"></script>
    <script src="/static/js/projects.js"></script>
  </body>
</html>

